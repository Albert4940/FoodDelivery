@model FoodDeliveryWebApp.Models.OrderViewModel;
@{
        <p>@ViewData["id"]</p>
    var clientId = @TempData["Result"];
}

<script src="https://www.paypal.com/sdk/js?client-id=@(clientId)&components=buttons"></script>

<div class="p-5">
    <div class="mx-auto p-3 bg-primary w-50">
        <h2 class="text-center mb-5">Complete your order</h2>
        <div class="row mb-3">

        </div>
        <div id="notification-container">

        </div>
        <div id="paypal-button-container"></div>
    </div>
</div>

@section Scripts {
    <script>
        let paypal_buttons = paypal.Buttons({
            createOrder() {
                return fetch("/Checkout/Create", {
                    method: "POST"
                })
                    .then((response) => response.json())
                    .then((order) =>  order.id );
            },
            onApprove(data) {
                paypal_buttons.close();
                
                // This function captures the funds from the transaction.
                return fetch("/Checkout/Complete", {
                    method: "POST",
                    headers: {
                        "Content-Type":"application/json",
                    },
                    body: JSON.stringify({
                        orderID: data.orderID
                    })
                })
                    .then((response) => response.json())
                    .then((details) => {
                        // This function shows a transaction success message to your buyer.
                        //Add this method into utils or helper
                        if (details == "success")
                            $("#notification-container").text('<div class="alert alert-success" role="alert">The order is created successfully!</div>');
                        else
                            $("#notification-container").text('<div class="alert alert-danger" role="alert">Failed Approuve Order!</div>');
                    });
            },
            onCancel(data) {
                // Show a cancel page, or return to cart
                $("#notification-container").text('<div class="alert alert-info" role="alert">Order Canceled!</div>');

                return fetch("/checkout/Cancel", {
                    method: "POST",
                    body: JSON.stringify({
                        orderID: data.orderID
                    })
                })
            },

            onError(err) {
                // For example, redirect to a specific error page
                $("#notification-container").text('<div class="alert alert-danger" role="alert">Failed created !!' + err + ' - </div>');
            }
        });
        paypal_buttons.render('#paypal-button-container');
    </script>
}